services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      #- "--api.insecure=true" # DISABLED for Production Readiness
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - onm-network

  postgres:
    image: postgres:16-alpine
    container_name: onm-postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-obsidian_media}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - onm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: onm-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - onm-network
    # CRITICAL: Prevent Redis from deleting BullMQ jobs when memory is full
    command: >
      redis-server
      --maxmemory-policy noeviction
      --appendonly yes
      --appendfsync everysec

  # Applications
  api:
    build:
      context: ../
      dockerfile: apps/api/Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/obsidian_media}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - PORT=3011
    ports:
      - "3011:3011"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - onm-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3011/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.localhost`)"
      - "traefik.http.services.api.loadbalancer.server.port=3011"
  
  worker:
    build:
      context: ../
      dockerfile: apps/worker/Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/obsidian_media}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - WORKER_METRICS_PORT=9110
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "9110:9110"
    networks:
      - onm-network

  web:
    build:
      context: ../
      dockerfile: apps/web/Dockerfile
    environment:
      - NEXT_PUBLIC_API_BASE=http://api:3011
    ports:
      - "3010:3010"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - onm-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`localhost`)"
      - "traefik.http.services.web.loadbalancer.server.port=3010"

  # AI Gateway (n8n backend) - DISABLED: Running locally instead
  # gateway:
  #   build:
  #     context: ../
  #     dockerfile: apps/gateway/Dockerfile
  #   container_name: onm-gateway
  #   restart: always
  #   environment:
  #     - PORT=8080
  #     - LOG_LEVEL=${LOG_LEVEL:-info}
  #     - GATEWAY_BEARER_TOKEN=${GATEWAY_BEARER_TOKEN}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
  #   ports:
  #     - "8081:8080"
  #   networks:
  #     - onm-network
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:2.4.6
    container_name: onm-n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      # n8n 2.0+ Security & Core Settings
      - N8N_RUNNERS_ENABLED=true
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false
      - N8N_PERSONALIZATION_ENABLED=false
      # Authentication
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      # Gateway connection
      - AI_GATEWAY_URL=http://gateway:8080/v1/agent/run
      - AI_GATEWAY_KEY=${GATEWAY_BEARER_TOKEN}
      # GitHub integration
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_OWNER=${GITHUB_OWNER:-}
      - GITHUB_REPO=${GITHUB_REPO:-}
      # Support email
      - SUPPORT_FROM_EMAIL=${SUPPORT_FROM_EMAIL:-}
      - SUPPORT_AUTOACK_ENABLED=${SUPPORT_AUTOACK_ENABLED:-false}
      - PUBLIC_SUPPORT_NAME=${PUBLIC_SUPPORT_NAME:-Support Team}
    volumes:
      - n8n_data:/home/node/.n8n
      - ../docs/n8n:/home/node/workflows:ro
    networks:
      - onm-network
    # depends_on:
    #   gateway:
    #     condition: service_healthy

networks:
  onm-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  n8n_data:
