generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LicenseStatus {
  ACTIVE
  PAST_DUE
  GRACE
  REVOKED
  EXPIRED
}

enum LicensePlan {
  FREE
  PRO
  LIFETIME
}

enum PaymentEventStatus {
  PENDING
  PROCESSED
  FAILED
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  stripeCustomerId String?   @unique
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  licenses         License[]
}

model License {
  id              String        @id @default(uuid())
  // Public key part for verification
  publicKey       String        @unique 
  // Hashed private key for issuance (never stored in plaintext)
  hashedKey       String
  keyVersion      Int           @default(1)
  
  userId          String
  status          LicenseStatus @default(ACTIVE)
  plan            LicensePlan   @default(PRO)
  
  stripeSubscriptionId String?

  features        Json          // e.g. ["4k-streaming"]
  deviceIdHashes  String[]      // List of authorized device hashes
  
  expiresAt       DateTime?
  graceEndsAt     DateTime?
  
  lastValidatedAt DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model PaymentEvent {
  id        String             @id @default(uuid())
  stripeId  String             @unique
  type      String             // e.g. "checkout.session.completed", "invoice.payment_failed"
  payload   Json
  status    PaymentEventStatus @default(PENDING)
  createdAt DateTime           @default(now())
  processedAt DateTime?
  error     String?
}
